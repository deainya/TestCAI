# Настройка n8n для интеграции с приложением

## Требования к n8n webhook

Для работы приложения необходимо настроить n8n workflow, который будет обрабатывать запросы от Streamlit приложения.

### Структура входящих данных

Приложение отправляет POST запросы с JSON payload:

```json
{
  "message": "Сообщение пользователя",
  "chat_history": [
    {
      "content": "Текст сообщения",
      "is_user": true/false
    }
  ],
  "problem_data": {
    "equipment_type": "Тип оборудования",
    "device_number": "Номер устройства", 
    "description": "Описание проблемы",
    "incident_date": "Дата инцидента",
    "photo_url": "URL фото"
  }
}
```

### Ожидаемый ответ от n8n

n8n должен возвращать JSON ответ:

```json
{
  "response": "Ответ ассистента пользователю",
  "problem_data": {
    "equipment_type": "Обновленные данные",
    "device_number": "Обновленные данные",
    "description": "Обновленные данные", 
    "incident_date": "Обновленные данные",
    "photo_url": "Обновленные данные"
  }
}
```

### Настройка переменной окружения

В Streamlit Community Cloud добавьте секрет:

- **Ключ:** `N8N_WEBHOOK_URL`
- **Значение:** URL вашего n8n webhook (например: `https://your-n8n-instance.com/webhook/your-webhook-id`)

### Логика обработки в n8n

1. **Получение сообщения** - webhook получает данные от приложения
2. **Анализ контекста** - LLM анализирует сообщение и историю чата
3. **Извлечение данных** - LLM извлекает информацию о проблеме
4. **Формирование ответа** - LLM генерирует ответ пользователю
5. **Возврат результата** - отправка ответа обратно в приложение

### Пример workflow в n8n

1. **Webhook Trigger** - для получения запросов
2. **LLM Node** - для обработки сообщений (OpenAI, Claude, etc.)
3. **Function Node** - для обработки и форматирования данных
4. **Response Node** - для отправки ответа

### Обработка ошибок

n8n должен обрабатывать следующие сценарии:
- Некорректные данные
- Таймауты LLM
- Ошибки подключения
- Неполные данные

Возвращать соответствующие сообщения об ошибках в поле `error`.
